---
title: "T-REX Analysis on COVID Vaccine Data"
author: "Sierra Barone"
contributors: "Claire Cross, and Cass Mayeda"
date: "09/02/2021"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
---

## Tracking Responders Expanding 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Data from Kramer et al., bioRxiv. 2021 (https://doi.org/10.1101/2021.07.28.453981)


# uncomment lines below to install packages
# if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
# BiocManager::install("cytoMEM")
# install.packages("tidyverse", repos = "http://cran.us.r-project.org")
# install.packages("ggplot2", repos = "http://cran.us.r-project.org")
# install.packages("tidyverse", repos = "http://cran.us.r-project.org")
# install.packages("uwot", repos = "http://cran.us.r-project.org")
# install.packages("dbscan", repos = "http://cran.us.r-project.org")
# if (!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
# BiocManager::install("flowCore")
# BiocManager::install("Biobase")


# load packages
library(flowCore)
library(uwot)
library(FNN)
library(ggplot2)
library(dbscan)
library(cytoMEM)
library(tidyverse)
library(Biobase)
library(RColorBrewer)
library(dplyr)
library(purrr)
library(cowplot)

source("R/TREX.R")

# set working directory 
setwd(paste(getwd(),"/data_files/covid vaccine", sep = ""))

# setup sample and T-REX info
output_filename = "_T-REX"
sample_type = "HIDI_COVID_Vaccine"
sample_id = "VCV_016"
time_comparison = "Post v Pre" 
kvalue = 60

# look at files
data.files <-  dir(pattern = "*.fcs")
print(data.files)
# choose index for each dataset based on order of data.files
first.dataset = 1
second.dataset = 2

# combine paired samples
first.dataset.data = as.data.frame(lapply(lapply(data.files[[first.dataset]], read.FCS), exprs))
first.dataset.data$orig_ID = first.dataset
first.dataset.data$File_ID = 1
second.dataset.data = as.data.frame(lapply(lapply(data.files[[second.dataset]], read.FCS), exprs))
second.dataset.data$orig_ID = second.dataset
second.dataset.data$File_ID = 2
paired.data = rbind(first.dataset.data, second.dataset.data)
orig.names <- colnames(paired.data)
colnames(paired.data)[1:(length(paired.data) - 2)] <- as.character(read.FCS(data.files[[1]])@parameters@data[["desc"]])
```

```{r equal_sampling}
# set seed and equally sample based on limiting sample
set.seed(1)
files.to.sample = split(paired.data,paired.data$`File_ID`)
sampled.data <- list()
for (i in 1: length(files.to.sample)){
    sampled.data[[i]] = as.data.frame(files.to.sample[[i]][sample(nrow(files.to.sample[[i]]), min(sapply(files.to.sample, nrow))), ])}
my.sampled.data = as.data.frame(do.call(rbind, sampled.data))
```

```{r scaling_and_filtering}
# choose markers to make low dimensional projection of the data and scale them accordingly 
#colnames(my.sampled.data)   
my.chosen.sampled.data = my.sampled.data[,c(3,8,10:14,16,27,29,33:38,42,44:46,50,52:53,55:60,62,70)]
#colnames(my.chosen.sampled.data) 
cofactor = c(45,15,10,10,10,15,5,15,25,15,15,15,15,15,25,25,15,15,25,15,15,45,15,15,45,25,25,15,25,15,25)

transformed.data = as.data.frame(t(apply(my.chosen.sampled.data, 1, function(x) asinh(x/cofactor))))
tsne.input = transformed.data
```

```{r tsne}
setwd(paste(getwd(),"/data_files/covid vaccine", sep = ""))

dir.create("./TREX_output/")
tsne.data = as.data.frame(cbind(my.sampled.data$tSNE1,my.sampled.data$tSNE2))
colnames(tsne.data) <- c("tSNE1", "tSNE2")
```

```{r run TREX}
setwd(paste0(getwd(),"/data_files/covid vaccine/TREX_output"))

my.binned = TREX(cbind(tsne.data, my.sampled.data$File_ID))

TREX_plot(my.binned, embed.type = "t-SNE")
```
  
```{r trex_results}  
setwd(paste(getwd(),"/data_files/covid vaccine", sep = ""))

tsne.bychannel <- as_tibble(tsne.data) %>%
  bind_cols(transformed.data)  %>%
  gather(channel, intensity, -tSNE1, -tSNE2) %>%
  mutate(across(channel,factor))%>%
  group_split(channel) %>%
  map(
    ~ggplot(.,aes(x = tSNE1, y = tSNE2, col = intensity)) +
      geom_point(shape = ".", size = 8) +
      scale_color_gradientn(
        colours = colorRampPalette(rev(brewer.pal(n = 11, name = "Spectral")))(5)) +
      facet_grid(~ channel, labeller = function(x) label_value(x, multi_line = FALSE)) +
      coord_fixed() +
      theme_bw() +
      theme(strip.text.x = element_text(size = 20), legend.title = element_blank())) %>%
  plot_grid(plotlist = ., align = 'hv', ncol = 8)

png(paste("./output files/",strftime(Sys.time(),"%Y-%m-%d_%H%M%S"),"t-SNE on transformed data.png"),height = 2000,width = 4000)
print(tsne.bychannel)
dev.off()

# uncomment lines below to plot heat on markers on tsne axes
# plot.to.output<-list()
# for (i in 1:ncol(tsne.input)){
#   color.plot <- data.frame(x = tsne.data[,1], y = tsne.data[,2], col = tsne.input[,c(i)])
#   order.plot <- color.plot[order(color.plot$col),]
#   print(ggplot(order.plot) + 
#           geom_point(aes(x = x, y = y, col = col), cex = 0.1, shape = 1) + 
#           coord_fixed(ratio = graphical.ratio) +
#           scale_color_gradientn(colours = colorRampPalette(rev(brewer.pal(n = 11, name = "Spectral")))(50)) + 
#           labs(x = "tSNE1", y = "tSNE2", col = colnames(tsne.input)[i]) +
#           theme_bw() + 
#           theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#   )
# }
```

```{r TREX stats}
setwd(paste0(getwd(),"/data_files/covid vaccine/TREX_output"))

TREX_stats(my.binned)
```

```{r clustering}
setwd(paste0(getwd(),"/data_files/covid vaccine/TREX_output"))

my.clusters = TREX_cluster(
  my.binned, 
  db.eps = 4, 
  marker.data = my.sampled.data
)

TREX_cluster_plot(my.clusters, my.binned, embed.type = "t-SNE")
```

```{r MEM}
setwd(paste0(getwd(),"/data_files/covid vaccine"))

# select markers
MEM.input = my.clusters[, c(7,12,14:18,20,31:35,37:42,44,46,48:54,56:66,74,85)]

# scale marker data 
cofactor = c(45,15,10,10,10,15,5,15,25,25,15,15,15,15,15,15,15,25,25,15,15,15,25,15,25,25,15,15,45,15,15,15,45,25,25,15,25,25,15,25,1)
MEM.input <- as.data.frame(t(apply(MEM.input, 1, function(x) asinh(x/cofactor))))
MEM.input[, 41] <- my.clusters[, 85]

# run MEM and rename markers 
MEM.output = MEM(
  MEM.input, 
  zero.ref = TRUE,
  new.marker.names = "CD45,CD66b,CD16,CD8,CD14,CD4,CD3,CD19,CD45R0,CPT1a,CD127,ATP5a,GRIM19,CD20,CD27,CCR4,CD134,ICOS,TCRgd,GLUT3,CXCR3,CD137,CCR7,CD98,CTLA4,Ki-67,GLUT1,CD95,CD44,CD38,CYTOC,CD25,CD45RA,CXCR5,CD57,CXCR4,HLA-DR,PD-1,CD56,CD11b",
  scale.matrix = "arcsinh",
  scale.factor = 1
)

build_heatmaps(
  MEM.output, 
  cluster.MEM = "none", 
  output.files = TRUE
)

```

```{r}
all.clusters = split(track.data,as.factor(track.data$cluster))
counts.total  <- sapply(all.clusters, NROW)
counts.5<-vector()
for (i in 1:length(all.clusters)){
  counts.5[i] = sum(all.clusters[[i]][["status"]] == '[0,5]')}
counts.95 = counts.total-counts.5
cluster.data = as.data.frame(counts.total)
colnames(cluster.data)<- "total_counts"
cluster.data$counts_5<-counts.5
cluster.data$counts_95<-counts.95
write.csv(cluster.data,paste("./output files/",strftime(Sys.time(),"%Y-%m-%d_%H%M%S")," DBSCAN_cluster_percentiles_counts_MEM.csv",sep =""))
print(cluster.data)
```


```{r export_FCS_files}
setwd(paste(getwd(),"/data_files/covid vaccine", sep = ""))

# export new FCS files with sampled data, percent change, and tsne axes
to.export = cbind(my.sampled.data,tsne.data,percent_change)
desc = colnames(to.export)[-c((ncol(my.sampled.data)-1):ncol(my.sampled.data))]
colnames(to.export)[1:ncol(my.sampled.data)]<-orig.names
separate.fcs.files = split(to.export,to.export$`orig_ID`)
for (i in 1:length(separate.fcs.files)){
reduce.data = subset(separate.fcs.files[[i]], select=-c(`File_ID`,`orig_ID`))
mat.input<- as.matrix(reduce.data)
metadata <- data.frame(name = dimnames(mat.input)[[2]], desc = desc)
metadata$range <- apply(apply(mat.input, 2, range), 2, diff)
metadata$minRange <- apply(mat.input, 2, min)
metadata$maxRange <- apply(mat.input, 2, max)
input.flowframe <- new("flowFrame", exprs=mat.input,parameters = AnnotatedDataFrame(metadata))  
newname  = str_remove(data.files[i], ".fcs")
new.filename = paste0("./output files/",strftime(Sys.time(),"%Y-%m-%d_%H%M%S"),"_",newname,"_T-REX.fcs",sep="")
write.FCS(input.flowframe,filename = new.filename)
print(paste("FCS file ",i," done", sep = ""))}

# print session information
sessionInfo()
```
