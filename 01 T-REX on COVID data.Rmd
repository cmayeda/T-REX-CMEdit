---
title: "T-REX Analysis on COVID Data"
author: "Sierra Barone"
contributors: "Claire Cross, Hannah Thirman, and Cass Mayeda"
date: "09/02/2022"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
---

## Tracking Responders Expanding 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Data from Brodin lab in Rodriguez et al., Cell Rep Med. 2020 (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7405891/)

# uncomment lines below to install packages
# if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
# BiocManager::install("cytoMEM")
# install.packages("tidyverse", repos = "http://cran.us.r-project.org")
# install.packages("ggplot2", repos = "http://cran.us.r-project.org")
# install.packages("FNN", repos = "http://cran.us.r-project.org")
# install.packages("tidyverse", repos = "http://cran.us.r-project.org")
# install.packages("uwot", repos = "http://cran.us.r-project.org")
# install.packages("dbscan", repos = "http://cran.us.r-project.org")
# if (!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
# BiocManager::install("flowCore")
# BiocManager::install("Biobase")

# load packages
library(flowCore)
library(uwot)
library(cytoMEM)
library(tidyverse)
library(Biobase)
library(dplyr)
library(purrr)
library(cowplot)

# load T-REX functions from local folder 
source("R/TREX.R")
```

```{r read in files}
# set working directory 
setwd(paste0(getwd(),"/data_files/brodin covid"))

# read in files 
data.filenames = dir(pattern = "*.fcs")
first.dataset = as.data.frame(lapply(lapply(data.filenames[[1]], read.FCS), exprs))
second.dataset = as.data.frame(lapply(lapply(data.filenames[[2]], read.FCS), exprs))

# save original column names for final export to FCS files 
orig.names = colnames(first.dataset)

# create meaningful names for data sets to be analyzed 
first.dataset$file_ID = "Timepoint 1"
second.dataset$file_ID = "Timepoint 2"

# rename columns with simplified marker names 
colnames(first.dataset)[1:(length(first.dataset) - 2)] <- as.character(read.FCS(data.filenames[[1]])@parameters@data[["desc"]])
colnames(second.dataset)[1:(length(second.dataset) - 2)] <- as.character(read.FCS(data.filenames[[1]])@parameters@data[["desc"]])
```

```{r equal sampling}
setwd(paste0(getwd(),"/data_files/brodin covid"))

# find number of datapoints in smaller sample 
smaller_sample = nrow(first.dataset) 
if (nrow(second.dataset) < smaller_sample) { 
  smaller_sample <- nrow(second.dataset) 
}

# get an equal number of datapoints from both datasets
set.seed(1)
sampled.data = as.data.frame(rbind(
  first.dataset[sample(nrow(first.dataset), smaller_sample), ], 
  second.dataset[sample(nrow(second.dataset), smaller_sample), ]
))

# rename columns with simplified marker names 
colnames(sampled.data)[1:(length(sampled.data) - 2)] <- as.character(read.FCS(data.filenames[[1]])@parameters@data[["desc"]])
```

```{r choose markers, scale data}
# choose markers to make low dimensional embedding 
chosen.data = sampled.data[, c(3,9:14,19:31,33:54,57:61)]

# scale data 
transformed.data = asinh(chosen.data/5) 
```

```{r create output folder}
dataset.names = unique(sampled.data$file_ID)
output.folder = paste0("T-REX output, ", dataset.names[1], " vs ", dataset.names[2])
dir.create(paste0(getwd(), "/data_files/brodin covid/", output.folder))
```

```{r UMAP}
setwd(paste0(getwd(),"/data_files/brodin covid/", output.folder))

# create UMAP (low dimensional embedding)
myumap <- umap(transformed.data, ret_model = TRUE, verbose = TRUE)

# uncomment the line below to save the UMAP 
save_uwot(myumap, paste0(getwd(), "/", strftime(Sys.time(),"%Y-%m-%d_%H_%M"),"_umap_results"))

umap.data = as.data.frame(myumap$embedding)
colnames(umap.data) <- c("UMAP1", "UMAP2")
```

```{r TREX}
setwd(paste0(getwd(),"/data_files/brodin covid/", output.folder))

my.TREX <- TREX(
  embedding.data = cbind(umap.data, file_ID = sampled.data$file_ID),
)

TREX_plot(
  binned.data = my.TREX,
  embed.type = "UMAP",
  caption = "Data from Brodin lab in Rodriguez et al., Cell Rep Med. 2020",
  export = TRUE
)
```

```{r}
setwd(paste0(getwd(),"/data_files/brodin covid/", output.folder))
TREX_results(my.TREX, export = TRUE)
```

```{r clustering}
setwd(paste0(getwd(),"/data_files/brodin covid/", output.folder))

my.clusters = TREX_cluster(
  binned.data = my.TREX, 
  db.eps = 0.3, 
  marker.data = chosen.data
)

TREX_cluster_plot(
  cluster.data = my.clusters,
  binned.data = my.TREX,
  embed.type = "UMAP", 
  export = TRUE
)
```
```{r cluster mean % change}
setwd(paste0(getwd(),"/data_files/brodin covid/", output.folder))
TREX_cluster_results(my.clusters, export = TRUE)
```


```{r marker heatmaps}  
setwd(paste0(getwd(),"/data_files/brodin covid/", output.folder))

# create heatmaps of every marker across UMAP axes 
umap.bychannel <- as_tibble(umap.data) %>%
  bind_cols(transformed.data)  %>%
  gather(channel, intensity, -UMAP1, -UMAP2) %>%
  mutate(across(channel, factor)) %>%
  group_split(channel) %>%
  map(
    ~ggplot(., aes(x = UMAP1, y = UMAP2, col = intensity)) +
      geom_point(shape = ".", size = 8) +
      scale_color_gradientn(
        colours = colorRampPalette(rev(brewer.pal(n = 11, name = "Spectral")))(5)) +
      facet_grid(~ channel, labeller = function(x) label_value(x, multi_line = FALSE)) +
      coord_fixed() +
      theme_bw() +
      theme(
        strip.text.x = element_text(size = 20),
        legend.title = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()
      )
    ) %>%
plot_grid(plotlist = ., align = 'hv', ncol = 8)

png(
  paste0(strftime(Sys.time(),"%Y-%m-%d_%H_%M"), "_marker_heat.png"),
  height = 2000,
  width = 4000
)
print(umap.bychannel)
dev.off()
```

```{r MEM}
setwd(paste0(getwd(),"/data_files/brodin covid/", output.folder))

# run MEM on DBSCAN clusters 
MEM.input = my.clusters[, c(6:ncol(my.clusters))]
MEM.input <- MEM.input[order(MEM.input$cluster), ]
MEM.values.KNN = MEM(
  MEM.input, 
  transform = TRUE, 
  cofactor = 5,
  choose.markers = FALSE, 
  markers = "all", 
  choose.ref = FALSE, 
  zero.ref = TRUE, 
  rename.markers = FALSE,
  new.marker.names = "none", 
  file.is.clust = FALSE, 
  add.fileID = FALSE, 
  IQR.thresh = NULL,
  scale.matrix = "arcsinh",
  scale.factor = 1
)
build_heatmaps(
  MEM.values.KNN, 
  cluster.MEM = "none", 
  cluster.medians = "none",
  display.thresh = 1, 
  output.files = TRUE, 
  labels = FALSE
)
```

``` {r count cells in each cluster}
setwd(paste0(getwd(),"/data_files/brodin covid/TREX_output"))

all.clusters = split(my.clusters, as.factor(my.clusters$cluster))
counts.total  <- sapply(all.clusters, NROW)
counts.5 <- vector()
for (i in 1:length(all.clusters)){
  counts.5[i] = sum(all.clusters[[i]][["cuts"]] == '[0,5]')
}
counts.95 = counts.total - counts.5
cluster.data = as.data.frame(counts.total)
colnames(cluster.data) <- "total_counts"
cluster.data$counts_5 <- counts.5
cluster.data$counts_95 <- counts.95
write.csv(cluster.data, paste(strftime(Sys.time(),"%Y-%m-%d_%H%M"), " DBSCAN_cluster_percentiles_counts_MEM.csv"))
print(cluster.data)
```

```{r export_FCS_files}
setwd(paste0(getwd(),"/data_files/brodin covid/TREX_output"))

# export new FCS files with sampled data, percent change, and umap axes
to.export = cbind(transformed.data, umap.data, my.TREX$percent.change)
desc = colnames(to.export)[-c(ncol(my.sampled.data), (ncol(my.sampled.data)-1))]
colnames(to.export)[1:ncol(my.sampled.data)] <- orig.names
separate.fcs.files = split(to.export, to.export$`orig_ID`)
for (i in 1:length(separate.fcs.files)) {
  reduce.data = subset(separate.fcs.files[[i]], select = -c(`File_ID`, `orig_ID`))
  mat.input <- as.matrix(reduce.data)
  metadata <- data.frame(name = dimnames(mat.input)[[2]], desc = desc)
  metadata$range <- apply(apply(mat.input, 2, range), 2, diff)
  metadata$minRange <- apply(mat.input, 2, min)
  metadata$maxRange <- apply(mat.input, 2, max)
  input.flowframe <- new("flowFrame", exprs = mat.input, parameters = AnnotatedDataFrame(metadata))  
  newname  = str_remove(data.files[i], ".fcs")
  new.filename = paste0(strftime(Sys.time(), "%Y-%m-%d_%H%M%S"), "_", newname, "_T-REX.fcs")
  write.FCS(input.flowframe,filename = new.filename)
  print(paste("FCS file ",i," done", sep = ""))
}

# needs testing ^ 

# print session information
sessionInfo()
```
